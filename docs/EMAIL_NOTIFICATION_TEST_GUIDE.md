# 📧 이메일 알림 테스트 가이드

환경 변수 설정이 완료되었으니 이제 테스트해봅시다! 🚀

---

## ✅ 사전 준비 완료 체크리스트

- [x] Gmail 앱 비밀번호 생성
- [x] `scripts/setup_email_notifications.sql` 실행 (DB 테이블 생성)
- [x] Supabase Edge Function 배포
- [x] 환경 변수 설정 (SMTP_USER, SMTP_PASS)
- [x] 프로필 페이지에 알림 설정 UI 추가

---

## 🧪 테스트 단계

### Step 1: 알림 설정하기 (2분)

1. **웹사이트 접속**
   - https://realpick.netlify.app (또는 로컬 개발 서버)

2. **로그인**
   - 계정으로 로그인

3. **프로필 페이지 이동**
   - 우측 상단 프로필 아이콘 클릭
   - 또는 `/p-profile` 직접 접속

4. **이메일 알림 설정**
   - 우측 사이드바에 "이메일 알림" 섹션 확인
   - **알림 받기** 토글 켜기 (ON)
   - **관심 카테고리** 선택:
     - ❤️ 로맨스
     - 🏆 서바이벌
     - ⭐ 오디션
   - **알림 설정 저장** 버튼 클릭

5. **저장 확인**
   - "저장 완료" 토스트 메시지 확인

---

### Step 2: 데이터베이스 확인 (선택사항)

Supabase Dashboard에서 확인:

1. **Table Editor** → `t_notification_preferences` 테이블
2. 당신의 사용자 데이터 확인:
   ```
   f_email_enabled: true
   f_categories: ['LOVE', 'VICTORY', 'STAR']
   ```

---

### Step 3: 테스트 미션 생성 (3분)

1. **미션 생성 페이지 이동**
   - 홈 화면에서 "+" 버튼 클릭

2. **미션 정보 입력**
   - **제목**: "이메일 알림 테스트"
   - **프로그램**: "나는 SOLO" (또는 원하는 프로그램)
   - **카테고리**: ❤️ **로맨스** (중요! 반드시 선택)
   - **미션 형식**: Binary, Multiple, Couple 중 선택
   - **옵션**: 선택지 입력
   - **마감 시간**: 내일 날짜 설정

3. **미션 게시**
   - "미션 게시" 버튼 클릭
   - "미션 게시 완료" 메시지 확인

---

### Step 4: 이메일 확인 (1-2분)

1. **Gmail 받은편지함 확인**
   - 새 이메일 도착 확인 (1-2분 소요)

2. **예상 이메일 내용**:
   - **발신자**: `RealPick <your-email@gmail.com>`
   - **제목**: `[RealPick] 새로운 로맨스 미션!`
   - **내용**:
     ```
     안녕하세요, [닉네임]님!
     
     관심 카테고리인 로맨스에 새로운 미션이 등록되었습니다.
     
     [미션 제목]
     📺 나는 SOLO · 로맨스
     
     지금 바로 참여하고 포인트를 획득하세요!
     예측이 맞으면 +100P, 공감 픽은 +10P를 받을 수 있습니다.
     
     🎯 미션 참여하기 [버튼]
     ```

3. **스팸함 확인**
   - 받은편지함에 없다면 스팸함 확인
   - 스팸함에 있다면 "스팸 아님" 표시

---

## 🔍 문제 해결

### 이메일이 안 오는 경우

#### 1. Edge Function 로그 확인

**Supabase Dashboard 방법**:
1. Supabase Dashboard → **Edge Functions**
2. `send-mission-notification` 클릭
3. **Logs** 탭 확인

**예상 로그**:
```
[Email Notification] Processing mission: {...}
[Email Notification] Found 1 subscribers
[Email] Successfully sent to: user@email.com
[Email Notification] Completed: 1/1 emails
```

#### 2. 일반적인 문제들

| 문제 | 원인 | 해결 방법 |
|------|------|-----------|
| 이메일 0통 발송 | 카테고리 미선택 | 미션 생성 시 카테고리 반드시 선택 |
| "SMTP not configured" | 환경 변수 미설정 | Supabase Secrets에 SMTP_USER, SMTP_PASS 추가 |
| "Authentication failed" | 잘못된 앱 비밀번호 | Gmail 앱 비밀번호 재생성 (공백 제거 확인) |
| 알림 설정 저장 안 됨 | DB 테이블 없음 | `setup_email_notifications.sql` 재실행 |
| "No subscribers found" | 알림 설정 안 함 | Step 1 다시 진행 |

#### 3. 디버깅 체크리스트

```
□ 미션 생성 시 카테고리를 선택했는가? (가장 중요!)
□ 알림 설정에서 해당 카테고리를 구독했는가?
□ 알림 설정에서 "알림 받기"가 켜져 있는가?
□ Supabase Secrets에 SMTP_USER, SMTP_PASS가 있는가?
□ Edge Function이 정상 배포되었는가?
□ Edge Function 로그에 에러가 있는가?
```

---

## 🎯 고급 테스트

### 다중 사용자 테스트

1. **다른 계정으로 로그인**
2. **알림 설정**
   - 다른 카테고리 선택 (예: 서바이벌만)
3. **미션 생성**
   - 로맨스 미션: 첫 번째 사용자만 알림
   - 서바이벌 미션: 두 번째 사용자만 알림

### 카테고리 필터링 테스트

1. **로맨스 카테고리만 구독**
2. **서바이벌 미션 생성**
3. **이메일 안 와야 정상** ✅

### 알림 OFF 테스트

1. **알림 받기 토글 끄기**
2. **미션 생성**
3. **이메일 안 와야 정상** ✅

---

## 📊 성공 기준

✅ **테스트 성공 조건**:
- [ ] 프로필 페이지에서 알림 설정 저장 성공
- [ ] 미션 생성 시 이메일 수신 (1-2분 내)
- [ ] 이메일 내용이 올바르게 표시됨
- [ ] 미션 참여하기 버튼 클릭 시 미션 페이지로 이동
- [ ] Edge Function 로그에 에러 없음

---

## 🎉 테스트 완료 후

### 다음 단계

1. **실제 사용자에게 공지**
   - "이메일 알림 기능이 추가되었습니다!"
   - 프로필 페이지에서 설정 가능

2. **모니터링**
   - Edge Function 로그 주기적 확인
   - Gmail 발송 제한 확인 (일일 500통)

3. **개선 사항**
   - 이메일 템플릿 디자인 개선
   - 알림 종류 추가 (댓글, 좋아요 등)
   - 알림 주기 설정 (즉시, 일일 요약 등)

---

## 📞 도움이 필요하면

1. **Edge Function 로그** 캡처해서 확인
2. **에러 메시지** 복사
3. **테스트 단계** 중 어디서 막혔는지 알려주세요

---

**🎊 테스트 성공을 기원합니다!**

문제가 있으면 언제든지 질문해주세요! 😊

